# PuPuCartDemo
仿朴朴购物车猜你喜欢列表商品加购效果

需求背景：《永辉生活》app购物车猜你喜欢商品加购时，列表会抖动，但是《朴朴》在加购时不会这样，所以需要对现有交互进行优化。但是因为没有实现过类似方案的经验，组内小伙伴在该需求的实现上也有一些技术上的疑问，所以决定深入研究一下朴朴的实现原理，并输出demo

一、《朴朴》加购交互现状
1. 购物车猜你喜欢商品加购时，如果上方商品列表没有滑动，则加购后新商品后猜你喜欢列表往下移动
2. 购物车猜你喜欢商品加购时，如果上方商品列表有向上滚动，则加购后新商品后猜你喜欢列表不会抖动，维持现有位置，往上滑动后能看到所有新加购的商品

二、方案调研
反编译朴朴的安装包.apk文件，去调研朴朴的实现方案
1. apk文件大小有37M，所以必定分包，但是发现apk包内的classes.dex文件只有一个，而且大小只有316.9kb，一定是对代码做了加固，所以通过代码的途径行不通

2. 从资源布局xml文件入手，打开res->layout文件夹，发现朴朴并没有对资源文件做名称混淆，所以尝试搜索"cart"、"shopping"等关键字
- 搜索定位到了fragment_shopping_cart.xml文件，发现里面的关键控件ShoppingCartCoordinatorLayout

- 猜测朴朴是通过两个列表来分别显示购物车商品和猜你喜欢商品，然后通过CoordinatorLayout和behavior来实现两个列表的联动，尝试搜索ShoppingCartCoordinatorLayout的子布局，定位到了merge_shopping_cart_list.xml，从名字上判断应该就是我们要找的布局文件，打开发现里面确实就是两个Recyclerview，并且设置了不同的behavior属性

三、具体实现
1、知道朴朴的方案之后，决定按照这个思路来实现，并输出demo
1. 先实现购物车商品列表的behavior----TopBehavior，思路参考《永辉生活》首页顶部behavior，当购物车商品列表没有划出屏幕时，手指拖动都是在使该列表的位置上移，然后消费掉该事件，不触发猜你喜欢列表的手势。

2. 接着实现猜你喜欢商品列表的behavior----BottomBehavior
猜你喜欢列表依赖于购物车商品列表。

3. activity中布局实现，CoordinatorLayout包裹两个RecyclerView，并分别设置不同的behavior，上面的RecyclerView高度需要设置成wrap_content，因为要测算其总高度来设置下方RecyclerView在y轴上的初始化偏移量

4. 代码中为两个RecyclerView设置测试数据，观察发现朴朴的购物车每个条目的高度是固定的，所以每次添加商品后能计算出添加的条目的总高度，作为一个高度差来设置上方RecyclerView的偏移量。

每次点击下方列表的item，模拟加购操作，为上方列表插入一条元素，如果上方列表的y轴偏移量不为0时，则手动向上偏移一个item的高度

四、总结
demo的behavior细节上需要做优化，但是已经基本实现了朴朴购物车猜你喜欢商品加购的交互效果。
当打算把该方案用于我们现有购物车时，发现会有问题，导致朴朴的这种实现可参考价值不是很大：
一是因为购物车商品列表的每个item高度必须固定，这样才能在加购之后针对多出来的item计算总差异高度，但是我们的购物车中每个item的高度都是wrap_content不固定的，这样就导致了加购之后没办法在第一时间获取到总差异高度，也就没法第一时间设置偏移量，就会有视觉上的差异；
二是因为上方购物车商品列表的高度是wrap_content，就会导致列表会一次性渲染出所有item，不会复用，如果在列表元素较多的情况下对性能有影响。
不过朴朴的该方案还是有可圈可点的地方，使整个购物车的用户体验会更好一些，用户的加购操作流程不会被打断。
